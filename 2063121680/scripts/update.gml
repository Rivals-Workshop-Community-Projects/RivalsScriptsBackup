//update

//Codec
if trummelcodecneeded{
    trummelcodec = 17;
    trummelcodecmax = 11;
    trummelcodecsprite1 = sprite_get("codec");
    trummelcodecsprite2 = sprite_get("X");
    var page = 0;

    //Page 0
    trummelcodecspeaker[page] = 2;
    trummelcodecexpression[page] = 0;

    trummelcodecline[page,1] = "look its zelda";
    trummelcodecline[page,2] = "";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;

    //Page 1
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 1;

    trummelcodecline[page,1] = "Very funny Trummel.";
    trummelcodecline[page,2] = "Looks like Link has";
    trummelcodecline[page,3] = "somehow found his way";
    trummelcodecline[page,4] = "into our world.";
    page++;

    //Page 2
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 2;

    trummelcodecline[page,1] = "I do wonder how he";
    trummelcodecline[page,2] = "ended up here, I doubt";
    trummelcodecline[page,3] = "his sheikah slate can";
    trummelcodecline[page,4] = "teleport him this far.";
    page++;
    
    //Page 3
    trummelcodecspeaker[page] = 2;
    trummelcodecexpression[page] = 0;

    trummelcodecline[page,1] = "just ask him lol";
    trummelcodecline[page,2] = "";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;
    
    //Page 4
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 1;

    trummelcodecline[page,1] = "Link has always been";
    trummelcodecline[page,2] = "the silent type. I";
    trummelcodecline[page,3] = "dont think talking to";
    trummelcodecline[page,4] = "him would be very useful";
    page++;
    
    //Page 5
    trummelcodecspeaker[page] = 3;
    trummelcodecexpression[page] = 0;

    trummelcodecline[page,1] = "Well excuuuuuuuuuuuuu";
    trummelcodecline[page,2] = "uuuuuuuuuuuuuuuuuuuuu";
    trummelcodecline[page,3] = "uuuuuuuuuuuuuuuuuuuuu";
    trummelcodecline[page,4] = "uuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuhonkuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuwuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuu";
    page++;
    
    //Page 6
    trummelcodecspeaker[page] = 3;
    trummelcodecexpression[page] = 1;

    trummelcodecline[page,1] = "-se me princess.";
    trummelcodecline[page,2] = "";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;
    
    //Page 7
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 5;

    trummelcodecline[page,1] = "...";
    trummelcodecline[page,2] = "";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;
    
    //Page 8
    trummelcodecspeaker[page] = 2;
    trummelcodecexpression[page] = 0;

    trummelcodecline[page,1] = "woag";
    trummelcodecline[page,2] = "";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;
    
    //Page 9
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 2;

    trummelcodecline[page,1] = "Um...";
    trummelcodecline[page,2] = "Well...";
    trummelcodecline[page,3] = "nice, talking to you...";
    trummelcodecline[page,4] = "...er... Link...";
    page++;
    
    //Page 10
    trummelcodecspeaker[page] = 2;
    trummelcodecexpression[page] = 0;

    trummelcodecline[page,1] = "which one of us";
    trummelcodecline[page,2] = "is the princess";
    trummelcodecline[page,3] = "";
    trummelcodecline[page,4] = "";
    page++;
    
    //Page 11
    trummelcodecspeaker[page] = 1;
    trummelcodecexpression[page] = 4;

    trummelcodecline[page,1] = "Not now Trummel!";
    trummelcodecline[page,2] = "Let's get back to";
    trummelcodecline[page,3] = "fighting, I'm already";
    trummelcodecline[page,4] = "creeped out!";
    page++;
}

if (trummelcodec_id != noone) {
    if (trummelcodec_id.codecindex == 4) && (trummelcodec_id.currentcodecline == 4) && (trummelcodec_id.codectimer2 >= 42) {
        trummelcodec_id.codecindex++;
        trummelcodec_id.currentcodecline = 1;
        trummelcodec_id.codectimer2 = 0;
        trummelcodec_id.codecprint[1] = "";
        trummelcodec_id.codecprint[2] = "";
        trummelcodec_id.codecprint[3] = "";
        trummelcodec_id.codecprint[4] = "";
    } else if (trummelcodec_id.codecindex == 5) {
        if (trummelcodec_id.currentcodecline == 1) && (trummelcodec_id.codectimer2 == 1) {
            sound_play(sound_get("excuse_me_start"));
        } else if (trummelcodec_id.currentcodecline == 4) && (trummelcodec_id.codectimer2 == 378) {
            trummelcodec_id.codecindex++;
            trummelcodec_id.currentcodecline = 1;
            trummelcodec_id.codectimer2 = 0;
            trummelcodec_id.codecprint[1] = "";
            trummelcodec_id.codecprint[2] = "";
            trummelcodec_id.codecprint[3] = "";
            trummelcodec_id.codecprint[4] = "";
        }
    } else if (trummelcodec_id.codecindex == 6) {
        if (trummelcodec_id.currentcodecline == 1) && (trummelcodec_id.codectimer2 == 1) {
            sound_play(sound_get("excuse_me_end"));
            sound_stop(sound_get("excuse_me_start"));
        }
    }
}

if runesUpdated {
    if runeE { //FSTRONG bombs comes out earlier.
        set_window_value(AT_FSTRONG, 1, AG_WINDOW_LENGTH, 1);
    } else {
        reset_window_value(AT_FSTRONG, 1, AG_WINDOW_LENGTH);
    }
    
    if runeM { //FSTRONG bombs stun.
        set_hitbox_value(AT_FSTRONG, 1, HG_EFFECT, 11);
        set_hitbox_value(AT_FSTRONG, 1, HG_BASE_HITPAUSE, 20);
        set_hitbox_value(AT_FSTRONG, 2, HG_EFFECT, 11);
        set_hitbox_value(AT_FSTRONG, 2, HG_BASE_HITPAUSE, 20);
    } else {
        reset_hitbox_value(AT_FSTRONG, 1, HG_EFFECT);
        reset_hitbox_value(AT_FSTRONG, 1, HG_BASE_HITPAUSE);
        reset_hitbox_value(AT_FSTRONG, 2, HG_EFFECT);
        reset_hitbox_value(AT_FSTRONG, 2, HG_BASE_HITPAUSE);
    }
    runesUpdated = false;
}

if swallowed { //Kirby ability script starts here
    swallowed = 0
    //Define any assets kirby might need to grab from YOUR CHARACTER
    var ability_spr = sprite_get("kirby_ability");
    var ability_hurt = sprite_get("kirby_ability_hurt")
    var ability_proj = sprite_get("bomb")
    var ability_icon = sprite_get("kirby_icon") //Optional
    var explosionVfxVar = fstrongExplosionVfx;
    var explosionSfxVar = sound_get("explosion");
    with enemykirby { //Define AT_EXTRA_3 for Kirby, using your asset variables where necessary in place of sprite_get or sound_get
        set_window_value(AT_EXTRA_3, 21, AG_WINDOW_ANIM_FRAMES, 69);
        explosionVfx = explosionVfxVar;
        explosionSfx = explosionSfxVar;
        
        set_attack_value(AT_EXTRA_3, AG_SPRITE, ability_spr);
        set_attack_value(AT_EXTRA_3, AG_HURTBOX_SPRITE, ability_hurt);
        set_attack_value(AT_EXTRA_3, AG_CATEGORY, 2);
        
        set_attack_value(AT_EXTRA_3, AG_NUM_WINDOWS, 3);
        
        set_window_value(AT_EXTRA_3, 1, AG_WINDOW_LENGTH, 10);
        set_window_value(AT_EXTRA_3, 1, AG_WINDOW_ANIM_FRAMES, 2);
        
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_LENGTH, 10);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_ANIM_FRAMES, 1);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_ANIM_FRAME_START, 2);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_HSPEED, 3);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_HSPEED_TYPE, 1);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_HAS_SFX, 1);
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_SFX, asset_get("sfx_swipe_weak1"));
        set_window_value(AT_EXTRA_3, 2, AG_WINDOW_SFX_FRAME, 4);
        
        set_window_value(AT_EXTRA_3, 3, AG_WINDOW_LENGTH, 16);
        set_window_value(AT_EXTRA_3, 3, AG_WINDOW_ANIM_FRAMES, 1);
        set_window_value(AT_EXTRA_3, 3, AG_WINDOW_ANIM_FRAME_START, 3);
        set_window_value(AT_EXTRA_3, 3, AG_WINDOW_HAS_WHIFFLAG, 1);
        
        set_num_hitboxes(AT_EXTRA_3, 1);
        
        set_hitbox_value(AT_EXTRA_3, 1, HG_HITBOX_TYPE, 2);
        set_hitbox_value(AT_EXTRA_3, 1, HG_WINDOW, 2);
        set_hitbox_value(AT_EXTRA_3, 1, HG_WINDOW_CREATION_FRAME, 0);
        set_hitbox_value(AT_EXTRA_3, 1, HG_LIFETIME, 300);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HITBOX_X, 0);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HITBOX_Y, -50);
        set_hitbox_value(AT_EXTRA_3, 1, HG_WIDTH, 35);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HEIGHT, 35);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PRIORITY, 3);
        set_hitbox_value(AT_EXTRA_3, 1, HG_DAMAGE, 6);
        set_hitbox_value(AT_EXTRA_3, 1, HG_ANGLE, 45);
        set_hitbox_value(AT_EXTRA_3, 1, HG_BASE_KNOCKBACK, 6);
        set_hitbox_value(AT_EXTRA_3, 1, HG_KNOCKBACK_SCALING, 0.5);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HIT_LOCKOUT, 10);
        set_hitbox_value(AT_EXTRA_3, 1, HG_BASE_HITPAUSE, 6);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HITPAUSE_SCALING, 1.0);
        set_hitbox_value(AT_EXTRA_3, 1, HG_VISUAL_EFFECT, 141);
        set_hitbox_value(AT_EXTRA_3, 1, HG_HIT_SFX, explosionSfxVar);
        
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_SPRITE, ability_proj);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_MASK, -1);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_HSPEED, 12);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_GRAVITY, 0.9);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_AIR_FRICTION, 0.3);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_WALL_BEHAVIOR, 1);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_GROUND_BEHAVIOR, 1);
        set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_DESTROY_EFFECT, 141);
        
        //explosion
        set_hitbox_value(AT_EXTRA_3, 2, HG_HITBOX_TYPE, 2);
        set_hitbox_value(AT_EXTRA_3, 2, HG_LIFETIME, 4);
        set_hitbox_value(AT_EXTRA_3, 2, HG_WIDTH, 90);
        set_hitbox_value(AT_EXTRA_3, 2, HG_HEIGHT, 90);
        set_hitbox_value(AT_EXTRA_3, 2, HG_PRIORITY, 3);
        set_hitbox_value(AT_EXTRA_3, 2, HG_DAMAGE, 6);
        set_hitbox_value(AT_EXTRA_3, 2, HG_ANGLE, 45);
        set_hitbox_value(AT_EXTRA_3, 2, HG_BASE_KNOCKBACK, 6);
        set_hitbox_value(AT_EXTRA_3, 2, HG_KNOCKBACK_SCALING, 0.5);
        set_hitbox_value(AT_EXTRA_3, 2, HG_HIT_LOCKOUT, 10);
        set_hitbox_value(AT_EXTRA_3, 2, HG_BASE_HITPAUSE, 6);
        set_hitbox_value(AT_EXTRA_3, 2, HG_HITPAUSE_SCALING, 1.0);
        set_hitbox_value(AT_EXTRA_3, 2, HG_VISUAL_EFFECT, 1);
        
        set_hitbox_value(AT_EXTRA_3, 2, HG_PROJECTILE_SPRITE, asset_get("empty_sprite"));
        set_hitbox_value(AT_EXTRA_3, 2, HG_PROJECTILE_MASK, -1);
        set_hitbox_value(AT_EXTRA_3, 2, HG_PROJECTILE_ANIM_SPEED, 1);
        set_hitbox_value(AT_EXTRA_3, 2, HG_PROJECTILE_DESTROY_EFFECT, 1);
    newicon = ability_icon //Optional, replaces the kirby ability icon
    } //Kirby ability script ends here
}

if enemykirby != undefined { //if kirby is in a match & has swallowed the character
    with oPlayer { //Run through all players
        if (get_window_value(AT_EXTRA_3,21,AG_WINDOW_ANIM_FRAMES) == 69) { //Arbitrary value in an unused window
            with pHitBox {
                if (player_id == other.id) && (attack == AT_EXTRA_3) && (hbox_num == 1) {
                    if (!free) || (place_meeting(x, y, asset_get("par_block"))) {
                        destroyed = true;
                        with oPlayer {
                            if (id == other.player_id) {
                                create_hitbox(AT_EXTRA_3, 2, other.x, other.y);
                                spawn_hit_fx(other.x, other.y, 141);
                                sound_play(explosionSfx);
                            }
                        }
                    }
                }
            }
            
            if ((state == PS_ATTACK_AIR || state == PS_ATTACK_GROUND) && attack == AT_EXTRA_3) {
                if (window == 1 && window_timer == 1) {
                    reset_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_HSPEED);
                }
                if (window == 1 && window_timer == 7 && special_down) {
                    window_timer = 6;
                    kirbyAbilityCount += 1;
                }
                if (window == 1 && (kirbyAbilityCount >= 60 || !special_down)) {
                    set_hitbox_value(AT_EXTRA_3, 1, HG_PROJECTILE_HSPEED, 12 + (kirbyAbilityCount/8));
                    window = 1;
                    window_timer = 9;
                    kirbyAbilityCount = 0;
                }
                if (window == 2) {
                    kirbyAbilityCount = 0;
                }
            }
        }
    }
}

//RAINBOWS!
hue_offset+=hue_speed;
hue_offset=hue_offset mod 255; //keeps hue_offset within the 0-255 range

color_rgb=make_color_rgb(254, 47, 206); //input rgb values here, uses rgb to create a gamemaker colour variable
hue=(color_get_hue(color_rgb)+hue_offset) mod 255; //finds the hue and shifts it
color_hsv=make_color_hsv(hue,color_get_saturation(color_rgb),color_get_value(color_rgb)); //creates a new gamemaker colour variable using the shifted hue
set_color_profile_slot(8, 2, color_get_red(color_hsv),color_get_green(color_hsv),color_get_blue(color_hsv)); //uses that variable to set the slot's new colours
init_shader();

if !((state == PS_ATTACK_AIR) && (attack == AT_DAIR || (attack == AT_NSPECIAL && free))) {
    sound_stop(sound_get("bullet_time"));
}

if (state == PS_PARRY) {
    if (state_timer == 1) {
        parrySoundVar = false;
    } else if (state_timer == 2) {
        if (parrySoundVar == false) {
            sound_play(sound_get("nom"));
            parrySoundVar = true;
        }
    }
}

if (magnesisReticleDraw) && (window == 2 || window == 3) {
    if (magnesisReticalTimer mod 140 == 0) {
        sound_play(sound_get("magnesis_hold"));
    }
    magnesisReticalTimer += 1;
    if (abs(retXAcc) + abs(retYAcc) > 1) {
        magnesisMoveStopVar = true;
        if (magnesisMoveTimer == 0) {
            sound_play(sound_get("magnesis_move_start"));
        }
        if (magnesisMoveTimer == 20) {
            sound_play(sound_get("magnesis_move_loop"), true);
        }
        magnesisMoveTimer += 1;
    } else {
        magnesisMoveTimer = 0;
        sound_stop(sound_get("magnesis_move_loop"));
        if (magnesisMoveStopVar == true) {
            sound_play(sound_get("magnesis_move_stop"));
            magnesisMoveStopVar = false;
        }
        
    }
} else {
    magnesisReticalTimer = 0;
    magnesisMoveTimer = 0;
    magnesisMoveStopVar = true;
    sound_stop(sound_get("magnesis_hold"));
    sound_stop(sound_get("magnesis_move_start"));
    sound_stop(sound_get("magnesis_move_loop"));
}

if (!free) {
    move_cooldown[AT_DAIR] = 0;
    move_cooldown[AT_NSPECIAL] = 0;
    uspecRepeat = false;
} else if (state != PS_RESPAWN && state != PS_ATTACK_GROUND) {
    sound_stop(sound_get("excuse_me_start"));
    sound_stop(sound_get("excuse_me_end"));
}

if (state == PS_PRATFALL) {
    wasInPratfall = true;
}

if (state == PS_WALL_JUMP) {
    uspecRepeat = false;
}

if (state == PS_PRATLAND) {
    if (state_timer == 0) && (wasInPratfall) {
        sound_play(sound_get("splat"));
    }
}

if !(state == PS_PRATFALL || state == PS_PRATLAND) {
    wasInPratfall = false;
}

if (state == PS_PRATFALL) && (attack == AT_USPECIAL) && (up_down) {
    state = PS_ATTACK_AIR;
    state_timer = 0;
    attack = AT_USPECIAL;
    window = 1;
    window_timer = 0;
    uspecRepeat = true;
}

if (uspecRepeat) {
    set_window_value(AT_USPECIAL, 2, AG_WINDOW_HSPEED, 0);
    set_window_value(AT_USPECIAL, 2, AG_WINDOW_HSPEED_TYPE, 0);
    set_window_value(AT_USPECIAL, 2, AG_WINDOW_VSPEED, 0);
    set_window_value(AT_USPECIAL, 2, AG_WINDOW_VSPEED_TYPE, 0);
}

//ustrong stuff

if ustrongPillarDraw {
    ustrongDrawTimer += 1;
    var heightMod = 1.6;
    if (ustrongDrawTimer * ustrongDrawTimer * heightMod > ustrongDrawHeight) {
        ustrongLiveHeight = ustrongDrawHeight;
    } else {
        ustrongLiveHeight = ustrongDrawTimer * ustrongDrawTimer * heightMod;
    }
    if (ustrongDrawTimer >= 40) {
        ustrongDrawHeight -= ((ustrongDrawTimer - 40) * 1.5);
    } else if (ustrongDrawTimer < 18) && (ustrongDrawTimer > 5) {
        set_hitbox_value(AT_USTRONG, 1, HG_HEIGHT, ustrongLiveHeight);
        if !(stasisID != undefined && stasisID.hitboxStasisPlayerID == id && stasisID.hitboxStasisAttack == AT_USTRONG) {
            create_hitbox(AT_USTRONG, 1, ustrongXVar + 52, ustrongYVar - floor(ustrongLiveHeight/2));
        }
        
        
    }
    
    if (ustrongDrawHeight <= 0) {
        ustrongDrawTimer = 0;
        ustrongPillarDraw = false;
    }
}

//stasis stuff

if (stasisID != undefined) {
    switch stasisID.stasisHitCounter {
        case 0:
        oppStasisHitSound = sound_get("stasis_hit1");
        stasisEndSound = sound_get("stasis_end_weak");
        break;
        case 1:
        oppStasisHitSound = sound_get("stasis_hit2");
        stasisEndSound = sound_get("stasis_end_weak");
        break;
        case 2:
        oppStasisHitSound = sound_get("stasis_hit3");
        stasisEndSound = sound_get("stasis_end_weak");
        break;
        case 3:
        oppStasisHitSound = sound_get("stasis_hit4");
        stasisEndSound = sound_get("stasis_end_medium");
        break;
        case 4:
        oppStasisHitSound = sound_get("stasis_hit5");
        stasisEndSound = sound_get("stasis_end_medium");
        break;
        case 5:
        oppStasisHitSound = sound_get("stasis_hit6");
        stasisEndSound = sound_get("stasis_end_medium");
        break;
        case 6:
        oppStasisHitSound = sound_get("stasis_hit7");
        stasisEndSound = sound_get("stasis_end_heavy");
        break;
        case 7:
        oppStasisHitSound = sound_get("stasis_hit8");
        stasisEndSound = sound_get("stasis_end_heavy");
        break;
        case 8:
        oppStasisHitSound = sound_get("stasis_hit_last");
        stasisEndSound = sound_get("stasis_end_heavy");
        break;
        case 9:
        oppStasisHitSound = sound_get("stasis_hit_last");
        stasisEndSound = sound_get("stasis_end_heavy");
        break;
    }
    if stasisID.stasisHitCounter >= 9 {
        stasisID.stasisHitCounter = 9;
    }
}



if (stasisType == "box") {
    stasisTimerMax = 580;
}


if (stasisActive) {
    stasisTimer += 1;
    //stasis hit counter
    if (stasisType == "box") {
        with obj_article_platform {
            if id == other.stasisID {
                inStasis = true;
                
                if (hitStasis) {
                    stasisHitSoundVar = true;
                    if (stasisHitSoundCounter == 0) {
                        sound_play(other.oppStasisHitSound);
                        stasisHitCounter += 1;
                        stasisEndHsp = stasisHitCounter*dcos(other.stasisAngle);
                        stasisEndVsp = stasisHitCounter*dsin(other.stasisAngle);
                    }
                    hitStasis = false;
                }
            }
        }
    } else {
        with oPlayer {
            if id == other.stasisID {
                inStasis = true;
                
                if (hitStasis) {
                    stasisHitSoundVar = true;
                    if (stasisHitSoundCounter == 0) {
                        if other.runeL { //Opponents take damage from attacks while in stasis.
                            var damage = get_hitbox_value(hitboxStasisAttack, hitboxStasisHboxNum, HG_DAMAGE);
                            take_damage(player, hitboxStasisPlayerID.player, floor(damage/2));
                        }
                        sound_play(other.oppStasisHitSound);
                        stasisEndHsp = stasisHitCounter*dcos(other.stasisAngle);
                        stasisEndVsp = stasisHitCounter*dsin(other.stasisAngle);
                        stasisHitCounter += 1;
                    }
                    hitStasis = false;
                }
            }
        }
    }
} else {
    stasisTimer = 0;
    if (stasisType == "box") {
        with obj_article_platform {
            if id == other.stasisID {
                inStasis = false;
            }
        }
    } else {
        with oPlayer {
            if id == other.stasisID {
                inStasis = false;
            }
        }
    }
    stasisID = undefined;
    stasisType = undefined;
}

if (stasisID != undefined) && (stasisTimer >= stasisTimerMax) {
        
    if (stasisID.hitboxStasisAttack == AT_NSPECIAL && stasisID.hitboxStasisPlayerID == id) {
        var angle = darctan2(-stasisID.hitboxStasisVsp, spr_dir*stasisID.hitboxStasisHsp);
    } else if (stasisID.hitboxStasisAngle != undefined) {
        var angle = darctan2(dsin(stasisID.hitboxStasisAngle), spr_dir*dcos(stasisID.hitboxStasisAngle));
    } else {
        var angle = 90;
    }
    set_hitbox_value(AT_DSPECIAL, 3, HG_ANGLE, angle);
    var damage = stasisID.stasisHitCounter * 2;
    set_hitbox_value(AT_DSPECIAL, 3, HG_DAMAGE, damage);
    if (stasisType != "box") {
        create_hitbox(AT_DSPECIAL, 3, stasisID.x, stasisID.y - 16);
    }
    
    sound_play(stasisEndSound);
    stasisActive = false;
    stasisTimer = 0;
    stasisID.stasisHitCounter = 0;
    
}

if (stasisTimer >= stasisTimerMax - 100) && (stasisTimer > 0) {
    if (stasisTimer mod 12 == 0) {
        sound_play(sound_get("stasis_timer"));
        stasisID.timerSoundVar = 0;
    }
} else if (stasisTimer >= stasisTimerMax - 270) && (stasisTimer > 0) {
    if (stasisTimer mod 24 == 0) {
        sound_play(sound_get("stasis_timer"));
        stasisID.timerSoundVar = 0;
    }
} else if (stasisTimer >= stasisTimerMax - 520) && (stasisTimer > 0) {
    if (stasisTimer mod 48 == 0) {
        sound_play(sound_get("stasis_timer"));
        stasisID.timerSoundVar = 0;
    }
}

//stasis hit detection
if (stasisType == "box") {
    with obj_article_platform {
        if (id == other.stasisID) {
            oppstasisTimer = other.stasisTimer;
            var prevAttack = hitboxStasisAttack;
            var prevHboxNum = hitboxStasisHboxNum;
            var prevID = hitboxStasisID;
            if (inStasis) {
                
                var instance = instance_place(x, y, pHitBox);
                if (instance != noone && oppstasisTimer >= 12 && stasisHitSoundVar == false) {
                    if (prevID != instance.id) {
                        hitStasis = true;
                    }
                    other.hitboxStasisPlayer = instance.player;
                    hitboxStasisPlayerID = instance.player_id;
                    hitboxStasisID = instance.id;
                    hitboxStasisAttack = instance.attack;
                    hitboxStasisHboxNum = instance.hbox_num;
                    hitboxStasisVsp = instance.vsp;
                    hitboxStasisHsp = instance.hsp;
                    hitboxStasisAngle = get_hitbox_angle(instance);
                }
            }
            
            if (stasisHitSoundVar == true) {
                stasisHitSoundCounter += 1;
                if (stasisHitSoundCounter >= 6) {
                    stasisHitSoundVar = false;
                    stasisHitSoundCounter = 0;
                }
            }
        }
    }
} else {
    with oPlayer {
        if (id != other.id) {
            var prevAttack = hitboxStasisAttack;
            var prevHboxNum = hitboxStasisHboxNum;
            var prevID = hitboxStasisID;
            var instanceXOffset = 15;
            var instanceYOffset = 0;
            if (inStasis) {
                oppStasisTimer = other.stasisTimer;
                invincible = true;
                invince_time = 2;
                /*
                //collision with hurtbox more accurate than oPlayer
                with pHurtBox {
                    if (player == other.player) {
                        var instance = instance_place(x, y, pHitBox);
                    }
                }
                */
                var instance = instance_place(x, y, pHitBox);
                if (instance == noone) {
                    instance = instance_place(x + instanceXOffset, y, pHitBox);
                    if (instance == noone) {
                        instance = instance_place(x - instanceXOffset, y, pHitBox);
                        if (instance == noone) {
                            instance = instance_place(x, y + instanceYOffset, pHitBox);
                            if (instance == noone) {
                                instance = instance_place(x, y - instanceYOffset, pHitBox);
                            }
                        }
                    }
                }
                if (instance != noone && oppStasisTimer >= 12 && stasisHitSoundVar == false) {
                    if (prevID != instance.id) {
                        hitStasis = true;
                    }
                    hitboxStasisPlayerID = instance.player_id;
                    hitboxStasisID = instance.id;
                    hitboxStasisAttack = instance.attack;
                    hitboxStasisHboxNum = instance.hbox_num;
                    hitboxStasisVsp = instance.vsp;
                    hitboxStasisHsp = instance.hsp;
                    hitboxStasisAngle = get_hitbox_angle(instance);
                }
                
            } else if state != PS_RESPAWN && state != PS_DEAD {
                invincible = false;
                invince_time = 0;
            }
            
            if (stasisHitSoundVar == true) {
                stasisHitSoundCounter += 1;
                if (stasisHitSoundCounter >= 6) {
                    stasisHitSoundVar = false;
                    stasisHitSoundCounter = 0;
                }
            }
        }
    }
}

if (stasisID != undefined) {
    if (stasisID.hitStasis == true) {
        if (stasisID.hitboxStasisAttack == AT_NSPECIAL && stasisID.hitboxStasisPlayerID == id) {
            stasisAngle = darctan2(-stasisID.hitboxStasisVsp, stasisID.hitboxStasisHsp);
        } else if (stasisID.hitboxStasisAngle != undefined) {
            stasisAngle = darctan2(dsin(stasisID.hitboxStasisAngle), dcos(stasisID.hitboxStasisAngle));
        } else {
            stasisAngle = 90;
        }
        
        if (stasisID.hitboxStasisAttack == AT_DAIR && stasisID.hitboxStasisPlayerID == id) {
            bulletBounce = true;
            sound_stop(sound_get("bullet_time"));
            if runeA { //DAIR can be used again after hitting an opponent with it.
                move_cooldown[AT_DAIR] = 0;
            } else {
                move_cooldown[AT_DAIR] = 10000000000;
            }
        }
    }
    if runeH { //Stasis launcher deals more knockback.
        var knockbackMod = 2 + (stasisID.stasisHitCounter * 1.8);
    } else {
        var knockbackMod = stasisID.stasisHitCounter;
    }
    
    var hitLockout = stasisID.stasisHitCounter * 7;
    set_hitbox_value(AT_DSPECIAL, 3, HG_BASE_KNOCKBACK, 1 + knockbackMod);
    //set_hitbox_value(AT_DSPECIAL, 3, HG_HIT_LOCKOUT, hitLockout);
}

//stasis keeps being buggy so imma destroy it if it does something wack
var stasisGlitched = false;
with obj_article_platform {
    if (inStasis) && (!other.stasisActive || other.stasisID != id) && (player_id == other.id) {
        stasisGlitched = true;
        inStasis = false;
        other.stasisID = undefined;
        other.stasisActive = false;
        //stasisHitSoundVar = false;
        //stasisHitSoundCounter = 1;
    }
}
with oPlayer {
    if (inStasis) && (id != other.id) {
        if !(state == PS_HITSTUN || state == PS_HITSTUN_LAND) || !(invincible) || (stasisGlitched) {
            other.stasisActive = false;
            inStasis = false;
            hitpause = false;
            other.stasisID = undefined;
            //stasisHitSoundVar = false;
            stasisHitCounter = 0;
        }
    }
}

if fs_hit fs_timer++;